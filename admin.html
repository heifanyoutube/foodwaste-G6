<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理員頁面 - 家庭 QR Code 借用系統</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #fff; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.6rem; text-align: center; }
    th { background-color: #007bff; color: white; }
    button { padding: 0.3rem 0.7rem; border: none; border-radius: 0.5rem; background: #dc3545; color: white; cursor: pointer; }
    button.clearAll { background: #6c757d; margin-left: 1rem; }
  </style>
</head>
<body>

  <h2>管理員頁面 - 家庭 QR Code 借用系統</h2>

  <button id="logoutBtn">登出</button>
  <button id="clearBtn" class="clearAll">清除所有借用紀錄</button>

  <table id="borrowTable">
    <thead>
      <tr>
        <th>二維碼編號</th>
        <th>借用者</th>
        <th>借用時間</th>
        <th>預覽</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUAzmBwdVs8wKpR9i4HB2x4E08xv-_8rE",
      authDomain: "g6-sys.firebaseapp.com",
      databaseURL: "https://g6-sys-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "g6-sys",
      storageBucket: "g6-sys.firebasestorage.app",
      messagingSenderId: "874000345226",
      appId: "1:874000345226:web:acb39a499e827135e3e573"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const qrImages = [
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278749/WhatsApp_Image_2025-07-22_at_12.39.27_PM_xkvl8y.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278749/WhatsApp_Image_2025-07-22_at_12.39.28_PM_1_sio7dp.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_2_ofjmf1.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_s69ynh.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_3_qx6dew.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.28_PM_2_sjey4c.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278747/WhatsApp_Image_2025-07-22_at_12.39.30_PM_qp7i4b.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_1_a5sp5c.jpg",
      "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_3_qx6dew.jpg"
    ];

    // 管理員登入驗證
    const user = prompt('請輸入管理員帳號：');
    const pwd = prompt('請輸入管理員密碼：');

    if (user !== 'hei' || pwd !== 'sh120419') {
      alert('管理員登入失敗');
      document.body.innerHTML = '<h3>無權限觀看此頁面</h3>';
      throw new Error('Unauthorized');
    }

    const borrowTableBody = document.querySelector('#borrowTable tbody');
    const clearBtn = document.getElementById('clearBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    function formatDate(timestamp) {
      const d = new Date(timestamp);
      return d.toLocaleString();
    }

    // 刪除單筆借用紀錄
    function deleteRecord(idx) {
      if (confirm(`確定要刪除二維碼 ${idx} 的借用紀錄嗎？`)) {
        remove(ref(db, 'qrcodes/' + idx))
          .then(() => {
            alert(`二維碼 ${idx} 的借用紀錄已刪除`);
            loadData();
          })
          .catch(e => alert('刪除失敗：' + e.message));
      }
    }

    function renderTable(data) {
      borrowTableBody.innerHTML = '';
      if (!data) {
        borrowTableBody.innerHTML = '<tr><td colspan="5">目前沒有借用紀錄</td></tr>';
        return;
      }

      for (const key in data) {
        if (data[key].by) {
          const tr = document.createElement('tr');

          const idxTd = document.createElement('td');
          idxTd.textContent = key;

          const byTd = document.createElement('td');
          byTd.textContent = data[key].by;

          const timeTd = document.createElement('td');
          timeTd.textContent = formatDate(data[key].time);

          const imgTd = document.createElement('td');
          const img = document.createElement('img');
          img.src = qrImages[key];
          img.style.width = '80px';
          img.style.borderRadius = '0.4rem';
          imgTd.appendChild(img);

          const actionTd = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.textContent = '刪除';
          delBtn.onclick = () => deleteRecord(key);
          actionTd.appendChild(delBtn);

          tr.appendChild(idxTd);
          tr.appendChild(byTd);
          tr.appendChild(timeTd);
          tr.appendChild(imgTd);
          tr.appendChild(actionTd);

          borrowTableBody.appendChild(tr);
        }
      }
    }

    // 載入借用資料
    async function loadData() {
      const snapshot = await get(ref(db, 'qrcodes'));
      renderTable(snapshot.val());
    }

    clearBtn.onclick = () => {
      if (confirm('確定要清除所有借用紀錄嗎？')) {
        remove(ref(db, 'qrcodes')).then(() => {
          alert('已清除所有借用紀錄');
          renderTable(null);
        });
      }
    };

    logoutBtn.onclick = () => {
      alert('登出成功');
      location.href = 'index.html';
    };

    loadData();

  </script>

</body>
</html>
