<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®¶åº­ QR Code å€Ÿç”¨ç³»çµ±</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; background: #f0f2f5; }
    header, footer { background: #fff; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card { background: #fff; padding: 1rem; border-radius: 1rem; box-shadow: 0 0 8px rgba(0,0,0,0.1); max-width: 300px; margin: auto; text-align: center; }
    img { max-width: 100%; border-radius: 0.5rem; }
    button { padding: 0.5rem 1rem; border: none; background: #007bff; color: #fff; border-radius: 0.5rem; cursor: pointer; margin: 1rem 0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .notice, .tutorial, .ranking { margin: 1rem 0; background: #fff; padding: 1rem; border-radius: 0.5rem; }
    .admin { display: none; margin-top: 2rem; }
    #qrCard { display: none; }
    #returnHomeBtn { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ“¢ å…¬å‘Šæ¬„</h2>
    <div id="notice">å°šç„¡å…¬å‘Š</div>
  </header>

  <section class="tutorial">
    <h3>ğŸ§¾ æ–°æ‰‹æ•™å­¸</h3>
    <ol>
      <li>è¼¸å…¥åå­—</li>
      <li>ç³»çµ±æœƒè‡ªå‹•åˆ†é…ä½ æ‰€éœ€æ•¸é‡çš„ QR Codeï¼Œä¸¦é€ä¸€é¡¯ç¤º</li>
      <li>å®Œæˆæ¯å€‹ QR Code å¾Œè«‹è¼¸å…¥å‰©é¤˜ç©åˆ†</li>
    </ol>
  </section>

  <div style="text-align:center">
    <label>ä½ çš„åå­—ï¼š<input type="text" id="username" /></label>
    <label>éœ€è¦å¹¾å€‹ QR Codeï¼š
      <input type="number" id="needCount" min="1" max="9" value="1" style="width:4rem" />
    </label>
    <button onclick="borrowNext()">æˆ‘è¦å€Ÿç”¨</button>
    <div>å‰©é¤˜å¯å€Ÿç”¨æ•¸é‡ï¼š<span id="availableCount">0</span></div>
  </div>

  <div class="card" id="qrCard">
    <img id="qrImage" src="" alt="QR Code" />
    <h3 id="qrName"></h3>
    <p id="qrStatus"></p>
    <button onclick="submitScore()">å®Œæˆä¸¦è¼¸å…¥ç©åˆ†</button><br />
    <button onclick="nextPage()">ä¸‹ä¸€é </button>
    <button id="returnHomeBtn" onclick="returnHome()" style="display:none;">è¿”å›é¦–é </button>
  </div>

  <div class="ranking">
    <h3>ğŸ† ç©åˆ†æ’è¡Œæ¦œ</h3>
    <ul id="rankingList"></ul>
  </div>

  <footer>
    <button onclick="adminLogin()">ğŸ” ç®¡ç†å“¡ç™»å…¥</button>
    <button onclick="adminLogout()" id="adminLogoutBtn" style="display:none;">ç™»å‡ºç®¡ç†å“¡</button>
    <div class="admin" id="adminPanel">
      <h3>ç®¡ç†å“¡æ§åˆ¶å°</h3>
      <label>å…¬å‘Šè¨Šæ¯ï¼š<br />
        <textarea id="adminNotice" rows="3" style="width:100%"></textarea>
      </label>
      <button onclick="updateNotice()">æ›´æ–°å…¬å‘Š</button>
      <h4>å€Ÿç”¨ç‹€æ…‹åŠé‡‹æ”¾äºŒç¶­ç¢¼</h4>
      <div id="adminQRCodes"></div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUAzmBwdVs8wKpR9i4HB2x4E08xv-_8rE",
      authDomain: "g6-sys.firebaseapp.com",
      databaseURL: "https://g6-sys-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "g6-sys",
      storageBucket: "g6-sys.firebasestorage.app",
      messagingSenderId: "874000345226",
      appId: "1:874000345226:web:acb39a499e827135e3e573"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // QR Code æ¸…å–®èˆ‡åç¨±
    const qrList = [
      { name: "Manhim", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278749/WhatsApp_Image_2025-07-22_at_12.39.27_PM_xkvl8y.jpg" },
      { name: "Yung", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278749/WhatsApp_Image_2025-07-22_at_12.39.28_PM_1_sio7dp.jpg" },
      { name: "Veronica", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_2_ofjmf1.jpg" },
      { name: "Ha2", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_s69ynh.jpg" },
      { name: "Yvonne", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_3_qx6dew.jpg" },
      { name: "Bobby", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.28_PM_2_sjey4c.jpg" },
      { name: "Ha", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278747/WhatsApp_Image_2025-07-22_at_12.39.30_PM_qp7i4b.jpg" },
      { name: "Oi", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_1_a5sp5c.jpg" },
      { name: "ting", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753339116/ting_g1afq7.jpg" }
    ];

    let user = '';
    let needCount = 1; // ç”¨æˆ¶éœ€è¦å¤šå°‘å€‹
    let borrowedIndexes = []; // ç”¨æˆ¶è¢«åˆ†é…çš„äºŒç¶­ç¢¼ç´¢å¼•é™£åˆ—
    let currentIndexInBorrowed = 0; // ç›®å‰é¡¯ç¤ºç¬¬å¹¾å€‹å€Ÿç”¨çš„äºŒç¶­ç¢¼

    // æ›´æ–°å‰©é¤˜å¯å€Ÿç”¨æ•¸é‡é¡¯ç¤º
    function updateAvailableCount() {
      get(ref(db, 'qrcodes')).then(snap => {
        const data = snap.val() || {};
        let count = 0;
        for(let i = 0; i < qrList.length; i++) {
          if(!data[i]) count++;
        }
        document.getElementById('availableCount').textContent = count;
      });
    }

    // å€Ÿç”¨æµç¨‹
    function borrowNext() {
      user = document.getElementById('username').value.trim();
      if (!user) return alert('è«‹è¼¸å…¥åå­—');
      needCount = parseInt(document.getElementById('needCount').value);
      if(isNaN(needCount) || needCount < 1) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡');
      get(ref(db, 'qrcodes')).then(snap => {
        const data = snap.val() || {};
        borrowedIndexes = [];
        for(let i = 0; i < qrList.length; i++) {
          if (!data[i] && borrowedIndexes.length < needCount) {
            borrowedIndexes.push(i);
          }
        }
        if(borrowedIndexes.length < needCount) {
          alert('å‰©é¤˜å¯ç”¨æ•¸é‡ä¸è¶³ï¼Œè«‹æ¸›å°‘å€Ÿç”¨æ•¸é‡');
          return;
        }
        // å¯«å…¥å€Ÿç”¨è³‡æ–™åˆ° firebaseï¼ˆåŒ…å«æ™‚é–“ï¼‰
        const updates = {};
        const now = Date.now();
        borrowedIndexes.forEach(i => {
          updates[`qrcodes/${i}`] = { by: user, time: now, score: 0 };
        });
        update(ref(db), updates).then(() => {
          currentIndexInBorrowed = 0;
          showQRCode(borrowedIndexes[currentIndexInBorrowed]);
          updateAvailableCount();
        });
      });
    }

    // é¡¯ç¤ºæŒ‡å®š QR Code
    function showQRCode(index) {
      document.getElementById('qrImage').src = qrList[index].url;
      document.getElementById('qrName').textContent = qrList[index].name;
      document.getElementById('qrStatus').textContent = `å·²åˆ†é…çµ¦ ${user}`;
      document.getElementById('qrCard').style.display = 'block';
      document.getElementById('returnHomeBtn').style.display = 'none';
    }

    // ç”¨æˆ¶è¼¸å…¥ç©åˆ†ä¸¦è‡ªå‹•è·³ä¸‹ä¸€é 
    function submitScore() {
      if (borrowedIndexes.length === 0) return alert('ç›®å‰æ²’æœ‰å¯è¼¸å…¥ç©åˆ†çš„äºŒç¶­ç¢¼');
      const qrIndex = borrowedIndexes[currentIndexInBorrowed];
      const scoreStr = prompt(`è«‹è¼¸å…¥ ${qrList[qrIndex].name} çš„å‰©é¤˜ç©åˆ†ï¼ˆæ•¸å­—ï¼‰`);
      if (!scoreStr || isNaN(scoreStr)) return alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—');
      const score = parseInt(scoreStr);
      update(ref(db, `qrcodes/${qrIndex}`), { score }).then(() => {
        alert(`å·²æ›´æ–° ${qrList[qrIndex].name} çš„ç©åˆ†`);
        nextPage();
      });
    }

    // ä¸‹ä¸€å€‹äºŒç¶­ç¢¼æˆ–çµæŸå€Ÿç”¨æµç¨‹
    function nextPage() {
      currentIndexInBorrowed++;
      if(currentIndexInBorrowed >= borrowedIndexes.length) {
        // å·²çœ‹å®Œæ‰€æœ‰åˆ†é…çš„äºŒç¶­ç¢¼
        document.getElementById('qrCard').style.display = 'none';
        alert('å·²å®Œæˆæ‰€æœ‰äºŒç¶­ç¢¼å€Ÿç”¨æµç¨‹ï¼Œè¬è¬ï¼');
        borrowedIndexes = [];
        currentIndexInBorrowed = 0;
        updateAvailableCount();
      } else {
        showQRCode(borrowedIndexes[currentIndexInBorrowed]);
      }
    }

    // è¿”å›é¦–é ï¼ˆé‡ç½®ä»‹é¢ï¼‰
    function returnHome() {
      document.getElementById('qrCard').style.display = 'none';
      borrowedIndexes = [];
      currentIndexInBorrowed = 0;
      updateAvailableCount();
    }

    // ç®¡ç†å“¡ç™»å…¥
    function adminLogin() {
      const a = prompt('å¸³è™Ÿ');
      const p = prompt('å¯†ç¢¼');
      if (a === 'admin' && p === '1234') {
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('adminLogoutBtn').style.display = 'inline-block';
        loadAdminData();
      } else {
        alert('ç™»å…¥å¤±æ•—');
      }
    }

    // ç®¡ç†å“¡ç™»å‡º
    function adminLogout() {
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('adminLogoutBtn').style.display = 'none';
    }

    // è¼‰å…¥ç®¡ç†å“¡è³‡æ–™
    function loadAdminData() {
      get(ref(db, 'notice')).then(snap => {
        const n = snap.val();
        document.getElementById('adminNotice').value = n ? n.text : '';
      });
      onValue(ref(db, 'qrcodes'), snap => {
        const data = snap.val() || {};
        const container = document.getElementById('adminQRCodes');
        container.innerHTML = qrList.map((qr, i) => {
          const info = data[i];
          const timeStr = info && info.time ? new Date(info.time).toLocaleString() : '-';
          return `<div>
            <b>${qr.name}</b> - ${info ? `å€Ÿå‡ºçµ¦ ${info.by} (ç©åˆ†: ${info.score || 0})ï¼Œå€Ÿç”¨æ™‚é–“: ${timeStr}` : 'æœªå€Ÿå‡º'}
            ${info ? `<button onclick="release(${i})">é‡‹æ”¾</button>` : ''}
          </div>`;
        }).join('');
      });
      updateAvailableCount();
    }

    // ç®¡ç†å“¡é‡‹æ”¾æŒ‡å®šäºŒç¶­ç¢¼
    function release(i) {
      remove(ref(db, `qrcodes/${i}`)).then(() => updateAvailableCount());
    }

    // æ›´æ–°å…¬å‘Š
    function updateNotice() {
      const text = document.getElementById('adminNotice').value.trim();
      set(ref(db, 'notice'), { text });
    }

    // å¯¦æ™‚ç›£è½å…¬å‘Šæ¬„æ›´æ–°
    onValue(ref(db, 'notice'), snap => {
      const n = snap.val();
      document.getElementById('notice').textContent = n ? n.text : 'å°šç„¡å…¬å‘Š';
    });

   // ç©åˆ†æ’è¡Œæ¦œæ›´æ–° - é¡¯ç¤ºæ¯å€‹å€Ÿå‡ºäºŒç¶­ç¢¼åç¨±åŠç©åˆ†
onValue(ref(db, 'qrcodes'), snap => {
  const data = snap.val() || {};
  // æ”¶é›†å·²å€Ÿå‡ºä¸”æœ‰ç©åˆ†çš„äºŒç¶­ç¢¼è³‡æ–™
  const qrScores = [];
  qrList.forEach((qr, i) => {
    if(data[i] && data[i].score !== undefined) {
      qrScores.push({ name: qr.name, score: data[i].score });
    }
  });
  // ä¾åˆ†æ•¸é«˜ä½æ’åº
  qrScores.sort((a, b) => b.score - a.score);
  // é¡¯ç¤ºåœ¨æ’è¡Œæ¦œä¸­
  document.getElementById('rankingList').innerHTML = qrScores.map(qr => `<li>${qr.name} - ${qr.score} åˆ†</li>`).join('');
});


    // ç¶å®šå…¨åŸŸå‡½å¼ï¼Œçµ¦ HTML å‘¼å«
    window.borrowNext = borrowNext;
    window.submitScore = submitScore;
    window.nextPage = nextPage;
    window.returnHome = returnHome;
    window.adminLogin = adminLogin;
    window.adminLogout = adminLogout;
    window.updateNotice = updateNotice;
    window.release = release;

    // åˆå§‹æ›´æ–°å‰©é¤˜æ•¸é‡
    updateAvailableCount();

  </script>
</body>
</html>
