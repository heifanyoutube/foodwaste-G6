<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å®¶åº­ QR Code å€Ÿç”¨ç³»çµ± (å„ªåŒ–ç‰ˆ)</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    margin: 0;
    padding: 1rem;
    background: #f9fafb;
    color: #222;
  }
  header, footer {
    background: #fff;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: 0 auto 1rem auto;
    border-radius: 0.5rem;
  }
  h2, h3, h4 {
    margin: 0 0 0.5rem 0;
    font-weight: 600;
  }
  .tutorial, .notice, .ranking, .admin, #adminLoginForm {
    background: #fff;
    max-width: 900px;
    margin: 1rem auto;
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.05);
  }
  label {
    display: block;
    margin-bottom: 0.6rem;
    font-weight: 500;
  }
  input[type=text], input[type=number], input[type=password], textarea, select {
    width: 100%;
    max-width: 320px;
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    border-radius: 0.4rem;
    border: 1px solid #ccc;
    box-sizing: border-box;
    transition: border-color 0.2s ease;
  }
  input[type=text]:focus, input[type=number]:focus, input[type=password]:focus, textarea:focus, select:focus {
    border-color: #3b82f6;
    outline: none;
  }
  button {
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.6rem 1.4rem;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 1rem;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background: #a5b4fc;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #2563eb;
  }
  #systemStatusDisplay {
    font-weight: 700;
    font-size: 1.15rem;
    color: #444;
    text-align: center;
    margin-bottom: 1rem;
    transition: color 0.3s ease;
  }
  #systemStatusDisplay.open {
    color: #16a34a; /* ç¶ è‰² */
  }
  #systemStatusDisplay.closed {
    color: #dc2626; /* ç´…è‰² */
  }
  #systemStatusDisplay.custom {
    color: #ca8a04; /* é»ƒè‰² */
  }
  #borrowSection {
    max-width: 450px;
    margin: 0 auto 1rem auto;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.07);
  }
  #qrCard {
    max-width: 320px;
    margin: 1rem auto;
    background: white;
    padding: 1rem 1.2rem;
    border-radius: 1rem;
    box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
    text-align: center;
    display: none;
  }
  #qrCard img {
    border-radius: 0.6rem;
    max-width: 100%;
    max-height: 280px;
    object-fit: contain;
  }
  #qrCard h3 {
    margin: 0.8rem 0 0.3rem 0;
  }
  #qrCard p {
    margin: 0 0 1rem 0;
    font-weight: 500;
    color: #555;
  }
  .admin label input[type=radio] {
    margin-right: 0.5rem;
    cursor: pointer;
  }
  #customReason {
    width: 100%;
    max-width: 400px;
    margin-top: 0.5rem;
    border-color: #e5e7eb;
    display: none;
  }
  #adminQRCodes > div {
    margin-bottom: 0.7rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.4rem;
    font-size: 0.9rem;
  }
  #adminQRCodes button {
    margin-left: 1rem;
    background: #ef4444;
  }
  #qrcodeOrderPanel > div {
    margin-bottom: 0.7rem;
  }
  #qrcodeOrderPanel select {
    max-width: 280px;
  }
  @media (max-width: 480px) {
    body, header, footer, .tutorial, .notice, .ranking, .admin, #borrowSection {
      margin-left: 0.6rem;
      margin-right: 0.6rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }
    input[type=text], input[type=number], input[type=password], textarea, select {
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<header>
  <h2>ğŸ“¢ å…¬å‘Šæ¬„</h2>
  <div id="notice">å°šç„¡å…¬å‘Š</div>
</header>

<section class="tutorial">
  <h3>ğŸ§¾ æ–°æ‰‹æ•™å­¸</h3>
  <ol>
    <li>è¼¸å…¥åå­—</li>
    <li>ç³»çµ±æœƒè‡ªå‹•åˆ†é…ä½ æ‰€éœ€æ•¸é‡çš„ QR Codeï¼Œä¸¦é€ä¸€é¡¯ç¤º</li>
    <li>å®Œæˆæ¯å€‹ QR Code å¾Œè«‹è¼¸å…¥å‰©é¤˜ç©åˆ†</li>
  </ol>
</section>

<div id="systemStatusDisplay">ç³»çµ±ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</div>

<section id="borrowSection">
  <label for="username">ä½ çš„åå­—ï¼š</label>
  <input type="text" id="username" placeholder="è«‹è¼¸å…¥åå­—" />
  <label for="needCount">éœ€è¦å¹¾å€‹ QR Codeï¼š</label>
  <input type="number" id="needCount" min="1" max="9" value="1" />
  <button id="borrowBtn" onclick="borrowNext()" disabled>æˆ‘è¦å€Ÿç”¨</button>
  <div style="margin-top:0.5rem;">å‰©é¤˜å¯å€Ÿç”¨æ•¸é‡ï¼š<span id="availableCount">0</span></div>
</section>

<section id="qrCard">
  <img id="qrImage" src="" alt="QR Code" />
  <h3 id="qrName"></h3>
  <p id="qrStatus"></p>
  <button onclick="submitScore()">å®Œæˆä¸¦è¼¸å…¥ç©åˆ†</button><br />
  <button onclick="nextPage()">ä¸‹ä¸€é </button>
  <button id="returnHomeBtn" onclick="returnHome()" style="display:none;">è¿”å›é¦–é </button>
</section>

<section class="ranking">
  <h3>ğŸ† ç©åˆ†æ’è¡Œæ¦œ</h3>
  <ul id="rankingList"><li>æš«ç„¡ç©åˆ†è³‡æ–™</li></ul>
</section>

<footer>
  <section id="adminLoginForm" class="admin-login">
    <h3>ç®¡ç†å“¡ç™»å…¥</h3>
    <input type="text" id="adminAccount" placeholder="å¸³è™Ÿ" autocomplete="off" />
    <input type="password" id="adminPassword" placeholder="å¯†ç¢¼" autocomplete="off" />
    <button onclick="adminLogin()">ç™»å…¥</button>
  </section>

  <button id="adminLogoutBtn" style="display:none; margin: 1rem auto; display: block;" onclick="adminLogout()">ç™»å‡ºç®¡ç†å“¡</button>

  <section class="admin" id="adminPanel" style="display:none;">
    <h3>ç®¡ç†å“¡æ§åˆ¶å°</h3>

    <label>å…¬å‘Šè¨Šæ¯ï¼š<br />
      <textarea id="adminNotice" rows="3" placeholder="è«‹è¼¸å…¥å…¬å‘Šè¨Šæ¯"></textarea>
    </label>
    <button onclick="updateNotice()">æ›´æ–°å…¬å‘Š</button>

    <h4>ç³»çµ±ç‹€æ…‹è¨­å®š</h4>
    <label><input type="radio" name="systemStatus" value="open" /> é–‹æ”¾å€Ÿç”¨</label>
    <label><input type="radio" name="systemStatus" value="closed" /> æš«åœå€Ÿç”¨ï¼ˆç³»çµ±ç¶­è­·ä¸­ï¼‰</label>
    <label><input type="radio" name="systemStatus" value="custom" /> ç‰¹æ®ŠåŸå› é—œé–‰</label>
    <textarea id="customReason" rows="2" placeholder="è«‹è¼¸å…¥ç‰¹æ®Šé—œé–‰åŸå› "></textarea>
    <button onclick="updateSystemStatus()">æ›´æ–°ç³»çµ±ç‹€æ…‹</button>

    <h4>å€Ÿç”¨ç‹€æ…‹åŠé‡‹æ”¾äºŒç¶­ç¢¼</h4>
    <div id="adminQRCodes"></div>

    <h4>è¨­å®šäºŒç¶­ç¢¼å€Ÿç”¨å„ªå…ˆé †åº</h4>
    <div id="qrcodeOrderPanel"></div>
    <button onclick="saveQrcodeOrder()">å„²å­˜å„ªå…ˆé †åº</button>
  </section>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCUAzmBwdVs8wKpR9i4HB2x4E08xv-_8rE",
    authDomain: "g6-sys.firebaseapp.com",
    databaseURL: "https://g6-sys-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "g6-sys",
    storageBucket: "g6-sys.firebasestorage.app",
    messagingSenderId: "874000345226",
    appId: "1:874000345226:web:acb39a499e827135e3e573"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const qrList = [
    { name: "Manhim", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278749/WhatsApp_Image_2025-07-22_at_12.39.27_PM_xkvl8y.jpg" },
    { name: "Yung", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278749/WhatsApp_Image_2025-07-22_at_12.39.28_PM_1_sio7dp.jpg" },
    { name: "Veronica", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_2_ofjmf1.jpg" },
    { name: "Ha2", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_s69ynh.jpg" },
    { name: "Yvonne", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_3_qx6dew.jpg" },
    { name: "Bobby", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.28_PM_2_sjey4c.jpg" },
    { name: "Ha", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278747/WhatsApp_Image_2025-07-22_at_12.39.30_PM_qp7i4b.jpg" },
    { name: "Oi", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753278748/WhatsApp_Image_2025-07-22_at_12.39.29_PM_1_a5sp5c.jpg" },
    { name: "ting", url: "https://res.cloudinary.com/dnc2h7vxz/image/upload/v1753339116/ting_g1afq7.jpg" }
  ];

  let user = '';
  let needCount = 1;
  let borrowedIndexes = [];
  let currentIndexInBorrowed = 0;
  let systemStatus = "open";
  let systemReason = "";
  let qrcodeOrder = [];
  let isAdmin = false;

  // æŒ‰éˆ•å•Ÿç”¨åˆ¤æ–·
  function checkBorrowBtn() {
    const userInput = document.getElementById('username').value.trim();
    const count = parseInt(document.getElementById('needCount').value);
    const btn = document.getElementById('borrowBtn');
    btn.disabled = !userInput || isNaN(count) || count < 1 || systemStatus !== "open";
  }

  function showSystemStatus() {
    const el = document.getElementById('systemStatusDisplay');
    el.className = "";
    let txt = "";
    if(systemStatus === "open") {
      txt = "é–‹æ”¾å€Ÿç”¨ä¸­";
      el.classList.add("open");
    }
    else if(systemStatus === "closed") {
      txt = "æš«åœå€Ÿç”¨ï¼ˆç³»çµ±ç¶­è­·ä¸­ï¼‰";
      el.classList.add("closed");
    }
    else if(systemStatus === "custom") {
      txt = `é—œé–‰ï¼š${systemReason || "ç„¡ç‰¹åˆ¥èªªæ˜"}`;
      el.classList.add("custom");
    }
    else txt = "æœªçŸ¥ç‹€æ…‹";
    el.textContent = "ç³»çµ±ç‹€æ…‹ï¼š" + txt;
    checkBorrowBtn();
  }

  function updateAvailableCount() {
    get(ref(db, 'qrcodes')).then(snap => {
      const data = snap.val() || {};
      let count = 0;
      for(let i = 0; i < qrList.length; i++) {
        if(!data[i]) count++;
      }
      document.getElementById('availableCount').textContent = count;
    });
  }

  // å€Ÿç”¨é‚è¼¯æ”¹ç‚ºå„ªå…ˆé †åºä¾åºæ‰¾ç©ºé–’
  function borrowNext() {
    if(systemStatus !== "open") {
      alert("ç›®å‰ç³»çµ±ä¸é–‹æ”¾å€Ÿç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      return;
    }
    user = document.getElementById('username').value.trim();
    if (!user) return alert('è«‹è¼¸å…¥åå­—');
    needCount = parseInt(document.getElementById('needCount').value);
    if(isNaN(needCount) || needCount < 1) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡');

    get(ref(db, 'qrcodes')).then(snap => {
      const data = snap.val() || {};
      borrowedIndexes = [];
      for(const qrIndex of qrcodeOrder) {
        if(!data[qrIndex]) {
          borrowedIndexes.push(qrIndex);
        }
        if(borrowedIndexes.length >= needCount) break;
      }
      if(borrowedIndexes.length < needCount) {
        alert('å‰©é¤˜å¯ç”¨æ•¸é‡ä¸è¶³ï¼Œè«‹æ¸›å°‘å€Ÿç”¨æ•¸é‡');
        return;
      }
      const updates = {};
      const now = Date.now();
      borrowedIndexes.forEach(i => {
        updates[`qrcodes/${i}`] = { by: user, time: now, score: 0 };
      });
      update(ref(db), updates).then(() => {
        currentIndexInBorrowed = 0;
        showQRCode(borrowedIndexes[currentIndexInBorrowed]);
        updateAvailableCount();
      });
    });
  }

  function showQRCode(index) {
    document.getElementById('qrImage').src = qrList[index].url;
    document.getElementById('qrName').textContent = qrList[index].name;
    document.getElementById('qrStatus').textContent = `å·²åˆ†é…çµ¦ ${user}`;
    document.getElementById('qrCard').style.display = 'block';
    document.getElementById('returnHomeBtn').style.display = 'none';
  }

  function submitScore() {
    if(borrowedIndexes.length === 0) return alert('ç›®å‰æ²’æœ‰å¯è¼¸å…¥ç©åˆ†çš„äºŒç¶­ç¢¼');
    const qrIndex = borrowedIndexes[currentIndexInBorrowed];
    const scoreStr = prompt(`è«‹è¼¸å…¥ ${qrList[qrIndex].name} çš„å‰©é¤˜ç©åˆ†ï¼ˆæ•¸å­—ï¼‰`);
    if(!scoreStr || isNaN(scoreStr)) return alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—');
    const score = parseInt(scoreStr);
    update(ref(db, `qrcodes/${qrIndex}`), { score }).then(() => {
      alert(`å·²æ›´æ–° ${qrList[qrIndex].name} çš„ç©åˆ†`);
      nextPage();
    });
  }

  function nextPage() {
    currentIndexInBorrowed++;
    if(currentIndexInBorrowed >= borrowedIndexes.length) {
      document.getElementById('qrCard').style.display = 'none';
      alert('å·²å®Œæˆæ‰€æœ‰äºŒç¶­ç¢¼å€Ÿç”¨æµç¨‹ï¼Œè¬è¬ï¼');
      borrowedIndexes = [];
      currentIndexInBorrowed = 0;
      updateAvailableCount();
      // é¡¯ç¤ºè¿”å›é¦–é æŒ‰éˆ•
      document.getElementById('returnHomeBtn').style.display = 'inline-block';
    } else {
      showQRCode(borrowedIndexes[currentIndexInBorrowed]);
    }
  }

  function returnHome() {
    document.getElementById('qrCard').style.display = 'none';
    document.getElementById('returnHomeBtn').style.display = 'none';
  }

  // è®€å–å…¬å‘Š
  function loadNotice() {
    get(ref(db, 'notice')).then(snap => {
      const v = snap.val() || "å°šç„¡å…¬å‘Š";
      document.getElementById('notice').textContent = v;
      if(isAdmin) {
        document.getElementById('adminNotice').value = v;
      }
    });
  }

  // ç®¡ç†å“¡å…¬å‘Šæ›´æ–°
  function updateNotice() {
    if(!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
    const v = document.getElementById('adminNotice').value.trim();
    set(ref(db, 'notice'), v).then(() => {
      alert('å…¬å‘Šå·²æ›´æ–°');
      loadNotice();
    });
  }

  // è¼‰å…¥ç³»çµ±ç‹€æ…‹
  function loadSystemStatus() {
    get(ref(db, 'systemStatus')).then(snap => {
      const val = snap.val();
      if(val) {
        systemStatus = val.status || "open";
        systemReason = val.reason || "";
        const radios = document.querySelectorAll('input[name="systemStatus"]');
        radios.forEach(r => r.checked = (r.value === systemStatus));
        document.getElementById('customReason').value = systemReason;
        if(systemStatus === "custom") {
          document.getElementById('customReason').style.display = "block";
        } else {
          document.getElementById('customReason').style.display = "none";
        }
        showSystemStatus();
      }
    });
  }

  // ç³»çµ±ç‹€æ…‹æ›´æ–°
  function updateSystemStatus() {
    if(!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
    const radios = document.querySelectorAll('input[name="systemStatus"]');
    let newStatus = "open";
    radios.forEach(r => { if(r.checked) newStatus = r.value; });
    const reason = document.getElementById('customReason').value.trim();
    set(ref(db, 'systemStatus'), { status: newStatus, reason: reason }).then(() => {
      systemStatus = newStatus;
      systemReason = reason;
      alert('ç³»çµ±ç‹€æ…‹å·²æ›´æ–°');
      showSystemStatus();
    });
  }

  // ç•¶åˆ‡æ›ç³»çµ±ç‹€æ…‹æ™‚é¡¯ç¤º/éš±è—ç‰¹æ®ŠåŸå› è¼¸å…¥æ¡†
  document.querySelectorAll('input[name="systemStatus"]').forEach(radio => {
    radio.addEventListener('change', () => {
      if(radio.value === "custom" && radio.checked) {
        document.getElementById('customReason').style.display = "block";
      } else {
        document.getElementById('customReason').style.display = "none";
      }
    });
  });

  // ç®¡ç†å“¡ç™»å…¥ç™»å‡º
  function adminLogin() {
    const acc = document.getElementById('adminAccount').value.trim();
    const pwd = document.getElementById('adminPassword').value.trim();
    if(acc === 'admin' && pwd === '1234') {
      isAdmin = true;
      alert('ç®¡ç†å“¡ç™»å…¥æˆåŠŸ');
      document.getElementById('adminLoginForm').style.display = 'none';
      document.getElementById('adminLogoutBtn').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'block';
      loadAdminPanel();
      loadNotice();
      loadSystemStatus();
    } else {
      alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
    }
  }

  function adminLogout() {
    isAdmin = false;
    document.getElementById('adminLoginForm').style.display = 'block';
    document.getElementById('adminLogoutBtn').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'none';
    loadNotice();
    loadSystemStatus();
  }

  // è®€å–ä¸¦é¡¯ç¤ºç®¡ç†å“¡é¢æ¿ä¸­ QR Code å€Ÿç”¨ç‹€æ…‹
  function loadAdminPanel() {
    get(ref(db, 'qrcodes')).then(snap => {
      const data = snap.val() || {};
      const container = document.getElementById('adminQRCodes');
      container.innerHTML = "";
      for(let i=0; i < qrList.length; i++) {
        const status = data[i];
        let statusText = "æœªå€Ÿç”¨";
        let byText = "";
        if(status) {
          byText = status.by || "";
          statusText = `å€Ÿç”¨ä¸­ï¼š${byText}ï¼Œç©åˆ†ï¼š${status.score || 0}`;
        }
        const div = document.createElement('div');
        div.textContent = `${qrList[i].name} - ${statusText}`;
        if(status) {
          const btn = document.createElement('button');
          btn.textContent = 'é‡‹æ”¾';
          btn.onclick = () => {
            if(confirm(`ç¢ºå®šè¦é‡‹æ”¾ ${qrList[i].name} çš„å€Ÿç”¨ç‹€æ…‹ï¼Ÿ`)) {
              remove(ref(db, `qrcodes/${i}`)).then(() => {
                alert('å·²é‡‹æ”¾');
                loadAdminPanel();
                updateAvailableCount();
                loadRanking();
              });
            }
          };
          div.appendChild(btn);
        }
        container.appendChild(div);
      }
    });
    loadQrcodeOrderPanel();
  }

  // è®€å–äºŒç¶­ç¢¼å€Ÿç”¨é †åºä¸¦é¡¯ç¤ºæ’åºæ§åˆ¶é¢æ¿
  function loadQrcodeOrderPanel() {
    get(ref(db, 'qrcodeOrder')).then(snap => {
      const order = snap.val();
      if(Array.isArray(order) && order.length === qrList.length) {
        qrcodeOrder = order;
      } else {
        // é è¨­é †åº 0~8
        qrcodeOrder = [...Array(qrList.length).keys()];
      }
      const container = document.getElementById('qrcodeOrderPanel');
      container.innerHTML = "";
      for(let i=0; i < qrList.length; i++) {
        const div = document.createElement('div');
        const label = document.createElement('label');
        label.textContent = qrList[i].name + " é †åºï¼š ";
        const select = document.createElement('select');
        select.dataset.idx = i;
        for(let n=1; n <= qrList.length; n++) {
          const opt = document.createElement('option');
          opt.value = n;
          opt.textContent = n;
          select.appendChild(opt);
        }
        // è¨­å®šç›®å‰é †åº
        const pos = qrcodeOrder.indexOf(i);
        select.value = pos + 1;
        label.appendChild(select);
        div.appendChild(label);
        container.appendChild(div);
      }
    });
  }

  // å„²å­˜å„ªå…ˆé †åºè¨­å®š
  function saveQrcodeOrder() {
    if(!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
    const selects = document.querySelectorAll('#qrcodeOrderPanel select');
    let arr = [];
    selects.forEach(sel => {
      arr.push({ idx: parseInt(sel.dataset.idx), order: parseInt(sel.value) });
    });
    // æ ¹æ“š order æ’åºï¼Œå†å– idx
    arr.sort((a,b) => a.order - b.order);
    const newOrder = arr.map(a => a.idx);
    set(ref(db, 'qrcodeOrder'), newOrder).then(() => {
      qrcodeOrder = newOrder;
      alert('å„ªå…ˆé †åºå·²æ›´æ–°');
    });
  }

  // ç©åˆ†æ’è¡Œæ¦œï¼Œæ”¹ç‚ºé¡¯ç¤ºäºŒç¶­ç¢¼åç¨± + ç©åˆ†
  function loadRanking() {
    get(ref(db, 'qrcodes')).then(snap => {
      const data = snap.val() || {};
      const ul = document.getElementById('rankingList');
      ul.innerHTML = "";
      let hasData = false;
      for(let i = 0; i < qrList.length; i++) {
        const qrName = qrList[i].name;
        const qrData = data[i];
        const score = qrData && typeof qrData.score === "number" ? qrData.score : 0;
        if(score > 0) hasData = true;
        ul.innerHTML += `<li>${qrName}ï¼š${score} åˆ†</li>`;
      }
      if(!hasData) {
        ul.innerHTML = "<li>æš«ç„¡ç©åˆ†è³‡æ–™</li>";
      }
    });
  }

  // ç›£è½è¼¸å…¥æ¬„ä½ï¼Œæ§åˆ¶æŒ‰éˆ•å•Ÿç”¨ç‹€æ…‹
  document.getElementById('username').addEventListener('input', checkBorrowBtn);
  document.getElementById('needCount').addEventListener('input', checkBorrowBtn);

  // é é¢åˆå§‹åŒ–
  function init() {
    loadNotice();
    loadSystemStatus();
    updateAvailableCount();
    loadRanking();

    // é è¨­å€Ÿç”¨å„ªå…ˆé †åºç‚º0~8
    qrcodeOrder = [...Array(qrList.length).keys()];

    checkBorrowBtn();

    // ç›£è½ Firebase qrcodes æ›´æ–°ï¼ŒåŠæ›´æ–°å‰©é¤˜æ•¸é‡èˆ‡æ’è¡Œæ¦œ
    onValue(ref(db, 'qrcodes'), () => {
      updateAvailableCount();
      loadRanking();
      if(isAdmin) loadAdminPanel();
    });

    onValue(ref(db, 'notice'), () => {
      loadNotice();
    });

    onValue(ref(db, 'systemStatus'), () => {
      loadSystemStatus();
    });
  }

  window.adminLogin = adminLogin;
  window.adminLogout = adminLogout;
  window.updateNotice = updateNotice;
  window.updateSystemStatus = updateSystemStatus;
  window.borrowNext = borrowNext;
  window.submitScore = submitScore;
  window.nextPage = nextPage;
  window.returnHome = returnHome;
  window.saveQrcodeOrder = saveQrcodeOrder;

  init();

</script>

</body>
</html>
